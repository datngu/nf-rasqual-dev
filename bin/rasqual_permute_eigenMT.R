#!/usr/bin/env Rscript

# Author: Dat T Nguyen <ndat@utexas.edu>
# Date: 12 Sep 2022

syntax="
Usage: rasqual.R vcf=path/to/vcf.gz y=path/to/feature_count.bin k=path/to/offset.bin x=path/to/covariates.bin x_txt=path/to/covariates.txt meta=path/to/meta.txt out=path/to/output.txt cpu=16

Input parameters are:
    vcf=path/to/vcf.gz (tabix indexed)
    y=path/to/feature_count.bin
    k=path/to/offset.bin
    x=path/to/covariates.bin
    x_txt=path/to/covariates.txt
    meta=path/to/meta.txt - metadata matrix with the following columns (in the same order): gene_id, chromosome_name, strand, exon_starts, exon_ends, range_start, range_end, feature_snp_count, cis_snp_count. Values in range_start and range_end columns specify the start and end of the cis region. This matrix is generated by https://github.com/kauralasoo/rasqual/tree/master/rasqualTools.
    out=path/to/output.txt
    cpu=16 - core numbers

IMPORTANT NOTE: ordering in meta.txt should be the same with feature_count.bin
"

args = commandArgs(trailingOnly = TRUE)

options(stringsAsFactors = FALSE)
require(data.table)
require(foreach)
require(doParallel)

vcf = y = k = x = x_txt = meta = out = cpu = NA

if(length(args) < 4 ){
  cat("\nNot valid arguments, Program stop! \n")
  cat(syntax, useSource = TRUE)
  quit()
}

for (i in 1:length(args)){
  res=unlist(strsplit(args[i],"="))
  if (res[1] == "vcf") vcf = res[2]
  if (res[1] == "y") y = res[2]
  if (res[1] == "k") k = res[2]   
  if (res[1] == "x") x = res[2]
  if (res[1] == "x_txt") x_txt = res[2]
  if (res[1] == "meta") meta = res[2]
  if (res[1] == "out") out = res[2]
  if (res[1] == "cpu") cpu = res[2]     
}

if (is.na(cpu)) cpu=1
cpu = as.integer(cpu)
registerDoParallel(cores=cpu)

# /net/fs-2/scale/OrionStore/Scratch/ngda/paper1/nf-rasqual/work/57/50fc702d6ee02ba1b731c832bb3e38

# vcf="1.vcf.gz"
# y="1_atac.exp.bin"
# k="1_atac.size_factors.bin"
# x="1_atac.covs.bin"
# x_txt="1_atac.covs.txt"
# meta="1_snp_counts.tsv"
# out="test.txt"
# j = 10

info = as.data.frame(fread(meta))
covs = fread(x_txt)
n = nrow(covs)
dir.create("tem_results")

job_list = foreach(j = 1:nrow(info),.combine=rbind) %dopar% {
    row = info[j,]
    cmd = paste0("tabix ", vcf, " ", row[2], ":", row[6], "-", row[7])
    cmd = paste0(cmd, " | rasqual -y ", y, " -k ", k, " -x ", x, " -n ", n, " -j ", j, " -l ", row[9], " -m ", row[8] )
    cmd = paste0(cmd, " -s ", row[4], " -e ", row[5], " -f " , row[1])
    cmd = paste0(cmd, " --random-permutation --force > ./tem_results/", row[1])
    try(system(cmd))
}

## test
# dir.create("tem_results")

# job_list = foreach(j = 1:10,.combine=rbind) %dopar% {
#     row = info[j,]
#     cmd = paste0("tabix ", vcf, " ", row[2], ":", row[6], "-", row[7])
#     cmd = paste0(cmd, " | rasqual -y ", y, " -k ", k, " -x ", x, " -n ", n, " -j ", j, " -l ", row[9], " -m ", row[8] )
#     cmd = paste0(cmd, " -s ", row[4], " -e ", row[5], " -f " , row[1])
#     cmd = paste0(cmd, " -t > ./tem_results/", row[1])
#     system(cmd)
# }

cmd_merge = paste0("cat ./tem_results/* > ", out)
system(cmd_merge)
system("rm -rf ./tem_results")
cat("DONE!")
